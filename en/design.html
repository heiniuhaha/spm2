<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="generator" content="nico 0.2.3">
    <meta name="theme" content="spm 0.1">
    <title>Design Pattern</title>
    <link rel="stylesheet" href="../static/one.css" />
    <link rel="stylesheet" href="../static/syntax.css" />
  </head>
  <body>
    <div class="navigation" role="navigation">
      <div class="container">
        <a class="home" href="../">SPM</a>
        <div class="menu">
          <a href="../en/">English</a>
          <a href="../zh/">中文文档</a>
          <a href="../api/">API</a>
          <a href="../cli/">Manual</a>
        </div>
      </div>
    </div>
    <div class="document">
<div class="hentry">
  <h1 class="entry-title">Design Pattern</h1>
  <div class="entry-content"><p>Rethink the design of spm.</p>
<h2 id="the-core">The core</h2>
<p>Every function in the core should be a MUST-HAVE feature. Obviously, coffee is not in the core.</p>

<p>Think about compress, for example uglifyjs. It is not in the core either.
It&#39;s not a MUST-HAVE feature.</p>

<p>When we install spm, we install the core.</p>
<h2 id="the-plugins">The plugins</h2>
<p>It should be easy to extend spm without changing any code of spm.</p>

<p>Take an example of spm-uglifyjs.</p>

<p>A spm plugin should define <code>scripts</code> in its package.json:</p>
<div class="highlight"><pre><code class="javascript">{
    <span class="string">"scripts"</span>: {
        <span class="string">"postinstall"</span>: <span class="string">"scripts/post-install.js"</span>,
        <span class="string">"uninstall"</span>: <span class="string">"scripts/uninstall.js"</span>
    }
}
</code></pre></div>
<p>in <code>scripts/post-install.js</code>:</p>
<div class="highlight"><pre><code class="javascript">require(<span class="string">'spm'</span>).installPlugin(<span class="string">'spm-uglifyjs'</span>)
<span class="comment">// this will register spm-uglifyjs to ~/.spm/plugins</span>
</code></pre></div>
<p>When <code>npm install spm-uglifyjs -g</code>, it will run <code>scripts/post-install.js</code> after the installation.</p>

<p>in <code>scripts/uninstall.js</code>:</p>
<div class="highlight"><pre><code class="javascript">require(<span class="string">'spm'</span>).uninstallPlugin(<span class="string">'spm-uglifyjs'</span>)
<span class="comment">// this will remove spm-uglifyjs from ~/.spm/plugins</span>
</code></pre></div>
<p>When <code>npm uninstall spm-uglifyjs -g</code>, it will run <code>scripts/uninstall.js</code> after the uninstallation.</p>
<h2 id="the-lifecycle">The lifecycle</h2>
<ol>
<li><p>The very first step is collecting plugins:</p>

<ul>
<li>read <code>~/.spm/plugins</code></li>
<li>plugins = [require(..), require(..), ...]</li>
</ul></li>
<li><p>register plugins&#39; commands:</p>
<div class="highlight"><pre><code class="javascript">plugin.trigger(<span class="string">'registerCommand'</span>)
</code></pre></div></li>
<li><p>parse command line and distribute command. For example <code>spm help</code>:</p>

<pre>spm (2.0.0)

spm is a static package manager.

Options:
    --version               show spm version
    -h --help               show this menu

Commands:
    help                    show help info, try spm help build
    build                   from source to distributed package
    upload                  upload distributed package to spmjs.org

Extensions:
    init                    initialize CMD structure
</pre>

<p>If you installed spm-init, you will see the <code>Extensions</code> group in command line.</p></li>
<li><p>every built-in commands should have pre- and post-, take <code>build</code> for example:</p>
<div class="highlight"><pre><code class="javascript">plugins.forEach(<span class="keyword">function</span>(plugin) {
    plugin.prebuild &amp;&amp; plugin.prebuild(arguments);
});

spm.build(arguments)

plugins.forEach(<span class="keyword">function</span>(plugin) {
    plugin.postbuild &amp;&amp; plugin.postbuild(arguments);
});
</code></pre></div>
<p>For example, coffee will need <code>prebuild</code>, and uglify will need <code>postbuild</code>.</p></li>
</ol>
</div>
</div>
</div>
    <div class="footer">
      <p class="copyright">powered by <a href="http://lab.lepture.com/nico/">nico</a> 0.2.3</p>
    </div>
    <script src="http://static.alipayobjects.com/seajs/1.2.1/sea.js" data-main="../static/one.js"></script>
    <div class="github"><a class="github-link" href="https://github.com/spmjs/spm2">Fork me on GitHub</a></div>
  </body>
</html>